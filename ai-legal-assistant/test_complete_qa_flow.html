<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete QA Flow Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üß™ Complete QA Flow Test</h1>
    <p>This test verifies the complete QA session flow with proper timeout handling.</p>

    <div class="test-section info">
        <h3>üìã Test Plan</h3>
        <ol>
            <li>Login and get authentication token</li>
            <li>Create a QA session</li>
            <li>Ask multiple questions with proper timeout handling</li>
            <li>Verify responses are received without errors</li>
            <li>Test session persistence across multiple requests</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>üîê Step 1: Authentication</h3>
        <button onclick="testLogin()">Test Login</button>
        <div id="loginResult" class="log"></div>
    </div>

    <div class="test-section">
        <h3>üìù Step 2: Create QA Session</h3>
        <button onclick="createSession()" disabled id="createSessionBtn">Create Session</button>
        <div id="sessionResult" class="log"></div>
    </div>

    <div class="test-section">
        <h3>‚ùì Step 3: Ask Questions</h3>
        <input type="text" id="questionInput" placeholder="Enter your question..." style="width: 300px; padding: 5px;">
        <button onclick="askQuestion()" disabled id="askQuestionBtn">Ask Question</button>
        <div id="questionResult" class="log"></div>
    </div>

    <div class="test-section">
        <h3>üîÑ Step 4: Test Multiple Questions</h3>
        <button onclick="testMultipleQuestions()" disabled id="multipleQuestionsBtn">Test Multiple Questions</button>
        <div id="multipleQuestionsResult" class="log"></div>
    </div>

    <div class="test-section">
        <h3>üìä Test Results Summary</h3>
        <div id="summaryResult" class="log"></div>
    </div>

    <script>
        let authToken = null;
        let sessionId = null;
        let testResults = [];

        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            element.textContent += logMessage;
            element.scrollTop = element.scrollHeight;
            
            if (isError) {
                element.style.backgroundColor = '#f8d7da';
            } else {
                element.style.backgroundColor = '#d4edda';
            }
        }

        function resetLog(elementId) {
            const element = document.getElementById(elementId);
            element.textContent = '';
            element.style.backgroundColor = '#f8f9fa';
        }

        async function testLogin() {
            resetLog('loginResult');
            log('loginResult', 'üîÑ Testing login...');
            
            try {
                const response = await fetch('http://localhost:8000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'username=test@example.com&password=testpassword'
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    log('loginResult', `‚úÖ Login successful! Token: ${authToken.substring(0, 20)}...`);
                    document.getElementById('createSessionBtn').disabled = false;
                    testResults.push({ step: 'Login', status: 'SUCCESS', time: Date.now() });
                } else {
                    const error = await response.text();
                    log('loginResult', `‚ùå Login failed: ${response.status} - ${error}`, true);
                    testResults.push({ step: 'Login', status: 'FAILED', error: error });
                }
            } catch (error) {
                log('loginResult', `‚ùå Login error: ${error.message}`, true);
                testResults.push({ step: 'Login', status: 'ERROR', error: error.message });
            }
        }

        async function createSession() {
            resetLog('sessionResult');
            log('sessionResult', 'üîÑ Creating QA session...');
            
            try {
                const response = await fetch('http://localhost:8000/api/qa/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        document_id: 1, // Assuming document ID 1 exists
                        session_name: 'Test Session'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    sessionId = data.id;
                    log('sessionResult', `‚úÖ Session created! ID: ${sessionId}`);
                    document.getElementById('askQuestionBtn').disabled = false;
                    document.getElementById('multipleQuestionsBtn').disabled = false;
                    testResults.push({ step: 'Create Session', status: 'SUCCESS', sessionId: sessionId });
                } else {
                    const error = await response.text();
                    log('sessionResult', `‚ùå Session creation failed: ${response.status} - ${error}`, true);
                    testResults.push({ step: 'Create Session', status: 'FAILED', error: error });
                }
            } catch (error) {
                log('sessionResult', `‚ùå Session creation error: ${error.message}`, true);
                testResults.push({ step: 'Create Session', status: 'ERROR', error: error.message });
            }
        }

        async function askQuestion() {
            const question = document.getElementById('questionInput').value.trim();
            if (!question) {
                log('questionResult', '‚ùå Please enter a question first!', true);
                return;
            }

            resetLog('questionResult');
            log('questionResult', `üîÑ Asking question: "${question}"`);
            
            const startTime = Date.now();
            
            try {
                const response = await fetch('http://localhost:8000/api/qa/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        question: question,
                        session_id: sessionId
                    })
                });

                const endTime = Date.now();
                const duration = (endTime - startTime) / 1000;

                if (response.ok) {
                    const data = await response.json();
                    log('questionResult', `‚úÖ Question answered in ${duration.toFixed(2)}s`);
                    log('questionResult', `üìù Answer: ${data.answer}`);
                    log('questionResult', `üéØ Confidence: ${data.confidence_score}`);
                    log('questionResult', `ü§ñ Model: ${data.model_used}`);
                    testResults.push({ 
                        step: 'Ask Question', 
                        status: 'SUCCESS', 
                        duration: duration,
                        question: question,
                        answer: data.answer
                    });
                } else {
                    const error = await response.text();
                    log('questionResult', `‚ùå Question failed: ${response.status} - ${error}`, true);
                    testResults.push({ 
                        step: 'Ask Question', 
                        status: 'FAILED', 
                        error: error,
                        question: question
                    });
                }
            } catch (error) {
                const endTime = Date.now();
                const duration = (endTime - startTime) / 1000;
                log('questionResult', `‚ùå Question error after ${duration.toFixed(2)}s: ${error.message}`, true);
                testResults.push({ 
                    step: 'Ask Question', 
                    status: 'ERROR', 
                    error: error.message,
                    duration: duration,
                    question: question
                });
            }
        }

        async function testMultipleQuestions() {
            resetLog('multipleQuestionsResult');
            log('multipleQuestionsResult', 'üîÑ Testing multiple questions...');
            
            const questions = [
                'What is this document about?',
                'What are the main terms?',
                'Who are the parties involved?',
                'What is the duration of this agreement?'
            ];

            for (let i = 0; i < questions.length; i++) {
                const question = questions[i];
                log('multipleQuestionsResult', `\n--- Question ${i + 1}: ${question} ---`);
                
                const startTime = Date.now();
                
                try {
                    const response = await fetch('http://localhost:8000/api/qa/ask', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            question: question,
                            session_id: sessionId
                        })
                    });

                    const endTime = Date.now();
                    const duration = (endTime - startTime) / 1000;

                    if (response.ok) {
                        const data = await response.json();
                        log('multipleQuestionsResult', `‚úÖ Answered in ${duration.toFixed(2)}s: ${data.answer.substring(0, 100)}...`);
                        testResults.push({ 
                            step: `Question ${i + 1}`, 
                            status: 'SUCCESS', 
                            duration: duration,
                            question: question
                        });
                    } else {
                        const error = await response.text();
                        log('multipleQuestionsResult', `‚ùå Failed: ${response.status} - ${error}`, true);
                        testResults.push({ 
                            step: `Question ${i + 1}`, 
                            status: 'FAILED', 
                            error: error,
                            question: question
                        });
                    }
                } catch (error) {
                    const endTime = Date.now();
                    const duration = (endTime - startTime) / 1000;
                    log('multipleQuestionsResult', `‚ùå Error after ${duration.toFixed(2)}s: ${error.message}`, true);
                    testResults.push({ 
                        step: `Question ${i + 1}`, 
                        status: 'ERROR', 
                        error: error.message,
                        duration: duration,
                        question: question
                    });
                }

                // Wait 2 seconds between questions
                if (i < questions.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }

            // Generate summary
            generateSummary();
        }

        function generateSummary() {
            resetLog('summaryResult');
            
            const totalTests = testResults.length;
            const successfulTests = testResults.filter(r => r.status === 'SUCCESS').length;
            const failedTests = testResults.filter(r => r.status === 'FAILED').length;
            const errorTests = testResults.filter(r => r.status === 'ERROR').length;
            
            log('summaryResult', 'üìä TEST RESULTS SUMMARY');
            log('summaryResult', '========================');
            log('summaryResult', `Total Tests: ${totalTests}`);
            log('summaryResult', `‚úÖ Successful: ${successfulTests}`);
            log('summaryResult', `‚ùå Failed: ${failedTests}`);
            log('summaryResult', `‚ö†Ô∏è Errors: ${errorTests}`);
            log('summaryResult', `Success Rate: ${((successfulTests / totalTests) * 100).toFixed(1)}%`);
            
            if (successfulTests > 0) {
                const avgDuration = testResults
                    .filter(r => r.duration)
                    .reduce((sum, r) => sum + r.duration, 0) / testResults.filter(r => r.duration).length;
                log('summaryResult', `Average Response Time: ${avgDuration.toFixed(2)}s`);
            }
            
            log('summaryResult', '\nüìã Detailed Results:');
            testResults.forEach((result, index) => {
                const status = result.status === 'SUCCESS' ? '‚úÖ' : '‚ùå';
                const duration = result.duration ? ` (${result.duration.toFixed(2)}s)` : '';
                log('summaryResult', `${status} ${result.step}${duration}`);
                if (result.error) {
                    log('summaryResult', `   Error: ${result.error}`);
                }
            });

            // Update UI based on results
            if (successfulTests === totalTests) {
                document.getElementById('summaryResult').style.backgroundColor = '#d4edda';
                log('summaryResult', '\nüéâ ALL TESTS PASSED! The QA system is working correctly.');
            } else {
                document.getElementById('summaryResult').style.backgroundColor = '#f8d7da';
                log('summaryResult', '\n‚ö†Ô∏è Some tests failed. Check the errors above.');
            }
        }

        // Auto-focus on question input
        document.getElementById('questionInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                askQuestion();
            }
        });
    </script>
</body>
</html>

